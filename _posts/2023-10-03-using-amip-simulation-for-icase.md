---
layout: post
title: Using coupled simulation for offline runs
date: 2023-10-03 1:19
author: Tian
comments: true
categories: [E3SM]
tags: Null
---
Sometimes I conduct offline land simulations driven by the climate output from a coupled simulation. This approach is time-efficient for some land-feature tests, especially when the feedback loops between the land and the atmosphere aren't the primary concern. Here are the steps to accomplish this:

### 1. Coupled Simulation Configuration
- Make sure you add the following options to the **`user_nl_cpl`** file for the coupled simulation. This allows the coupled simulation to output the required atmosphere variables at 3hrly time step. One file per simulation day.
``` bash
histaux_a2x3hr = .true.
```

### 2. Locate Output Files from Coupled Simulation
- You will get **cpl** files like this in your run directory of the coupled simulation: 
`v2.LR.amip_trigrid_irrimip_irr_e2.cpl.ha2x3h.1895-01-01-10800.nc`
- Once the coupled simulation is done, I'd suggest archiving the results so that all these daily output files will be moved to **`/archive/cpl/hist/`** and the restart files will go to **`/archive/rest`**. This will make our life easier later.

### 3. Setting Up the Offline Run

#### Configuration xml Flags
```bash
    # turn on CPLHIST feature for DATM mode
    ./xmlchange DATM_MODE="CPLHIST"
    # define the CPLHIST directory
    ./xmlchange DATM_CPLHIST_DIR='/path/to/coupled/simulation/archive/cpl/hist/'
    # define the domain file of the ATM, needs to be identical to the one used in the coupled model
    ./xmlchange DATM_CPLHIST_DOMAIN_FILE='/lcrc/group/e3sm/data/inputdata/share/domains/domain.lnd.ne30pg2_oEC60to30v3.200220.nc'
    # define the year start and end of the CPLHIST files
    ./xmlchange DATM_CPLHIST_YR_START='1901'
    ./xmlchange DATM_CPLHIST_YR_END='2014'
    ./xmlchange DATM_CPLHIST_YR_ALIGN='1901'
    # define the case name of the coupled simulation
    ./xmlchange DATM_CPLHIST_CASE='v2.LR.amip_trigrid_irrimip_irr_e1'
``` 

#### Streamfile Synchronization
Ensure the streamfile names auto-generated by the CPLHIST feature match those produced by the coupled simulation (e.g.**`...cpl.ha2x3h.1895-01-01-10800.nc`**). If there's a mismatch, either rename the daily output files or adjust the code to align the auto-generated streamfile names. Thanks to Dalei for providing following solution to the latter approach.

- locate `/components/data_comps/datm/cime_config/namelist_definition_datm.xml`
- In this file, under `<entry id="strm_datfil">`, find the default way to define `CPLHISTForcings`. Current default are
```xml
        <value  stream="CPLHISTForcing.Solar">$DATM_CPLHIST_CASE.cpl.ha2x1hi.%ym.nc</value>
        <value  stream="CPLHISTForcing.nonSolarFlux">$DATM_CPLHIST_CASE.cpl.ha2x3h.%ym.nc</value>
        <value  stream="CPLHISTForcing.State3hr">$DATM_CPLHIST_CASE.cpl.ha2x3h.%ym.nc</value>
        <value  stream="CPLHISTForcing.State1hr">$DATM_CPLHIST_CASE.cpl.ha2x1h.%ym.nc</value>
```
change them to
```xml
        <value  stream="CPLHISTForcing.Solar">$DATM_CPLHIST_CASE.cpl.ha2x3h.%ymd-10800.nc</value>
        <value  stream="CPLHISTForcing.nonSolarFlux">$DATM_CPLHIST_CASE.cpl.ha2x3h.%ymd-10800.nc</value>
        <value  stream="CPLHISTForcing.State3hr">$DATM_CPLHIST_CASE.cpl.ha2x3h.%ymd-10800.nc</value>
        <value  stream="CPLHISTForcing.State1hr">$DATM_CPLHIST_CASE.cpl.ha2x3h.%ymd-10800.nc</value>
```

#### Simulation Resolution and Configuration
Make sure that the offline simulation uses the exact resolution as the coupled simulation when creating the case (e.g. **`ne30pg2_r05_oECv3`**). I was originally thought think that only land resolution needs to be defined in an offline run. Also for the compset, you need to be careful that the land configuration in your offline compset may not be identical to the land configuration in the coupled simulation. Using long name instead of alias could avoid this.  